<!DOCTYPE html>
<html lang="sq">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Editor i Dokumenteve PDF dhe Excel</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --main-bg: #181d23;
  --card-bg: #232a34;
  --accent: #1976d2;
  --accent-dark: #0d47a1;
  --accent-light: #42a5f5;
  --primary: #263859;
  --primary-dark: #1a2233;
  --secondary: #374151;
  --text: #e3e8ee;
  --text-light: #b0b8c1;
  --button-bg: linear-gradient(90deg, #1976d2 60%, #263859 100%);
  --button-hover: linear-gradient(90deg, #263859 60%, #1976d2 100%);
  --button-alt: linear-gradient(90deg, #232a34 60%, #1976d2 100%);
  --shadow: 0 4px 32px rgba(25, 118, 210, 0.13);
  --border: #263859;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
body{
  background: var(--main-bg);
  padding:32px;
  min-height:100vh;
  color:var(--text);
  transition:background 0.4s;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}
.container{
  max-width: 794px; /* A4 width at 96dpi */
  min-height: 1123px; /* A4 height at 96dpi */
  margin: 0 auto;
  background: var(--card-bg);
  border-radius: 8px;
  box-shadow: var(--shadow);
  border: 1.5px solid var(--border);
  overflow: hidden;
  width: 100%;
}
.toolbar{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
  padding:18px 28px;
  background:var(--primary-dark);
  align-items:center;
  border-bottom:1.5px solid var(--border);
  box-shadow:var(--shadow);
  position:sticky;
  top:0;
  z-index:10;
}
.toolbar button,
.toolbar label{
  padding:12px 22px;
  font-size:1rem;
  border-radius:50px;
  border:none;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:500;
  transition:background 0.18s,box-shadow 0.18s, border 0.18s;
  box-shadow:0 1px 4px #1976d21a;
  background:var(--button-bg);
  color:white;
  border: 1.5px solid var(--border);
}
.toolbar .tool-button{
  background:var(--button-bg);
  color:white;
  border: 1.5px solid var(--border);
}
.toolbar .tool-button.active{
  background:var(--button-hover);
  color:var(--accent-light);
  border: 1.5px solid var(--accent-light);
}
.toolbar .btn{
  background:var(--button-alt);
  color:var(--accent-light);
  border: 1.5px solid var(--accent);
}
.toolbar .btn:hover,
.toolbar .tool-button:hover{
  background:var(--button-hover);
  color:#fff;
  box-shadow:0 2px 10px #1976d22a;
  border-color: var(--accent-light);
}
.file-name{
  font-size:1rem;
  font-weight:600;
  max-width:160px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  color:var(--accent-light);
  background:rgba(25,118,210,0.08);
  padding:6px 14px;
  border-radius:8px;
  margin-left:8px;
}
input[type="file"]{
  display:none;
}
.editor-container{
  position: relative;
  padding: 8px 4px 8px 4px; /* minimal margins */
  min-height: 1123px; /* A4 height */
  overflow: auto;
  background: var(--main-bg);
}
.document-preview{
  position: relative;
  overflow: auto;
  border: 1.5px solid var(--border);
  border-radius: 8px;
  background: var(--primary-dark);
  padding: 4mm; /* minimal margin, print-friendly */
  box-shadow: 0 2px 12px #1976d21a;
  min-height: 1123px; /* A4 height */
}
/* Drawing canvas overlay */
#drawing-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100% !important;
  height: 100% !important;
  z-index: 40;
  pointer-events: none;
}
.document-content{
  width:100%;
  min-height:100%;
  position:relative;
  padding:24px 10px;
  text-align:center;
  color:var(--accent-light);
}
.document-content h1{
  font-size:2.2rem;
  font-weight:700;
  margin-bottom:12px;
  color:var(--accent-light);
}
.document-content p{
  font-size:1.15rem;
  color:var(--text-light);
}
.signature-container,
.draggable-text{
  position:absolute;
  cursor:move;
  z-index:60;
  background:rgba(35,42,52,0.95);
  min-width:80px;
  min-height:20px;
  padding:2px 4px;
  border-radius:8px;
  border:1.5px dashed var(--accent);
  font-size:1.05rem;
  color:var(--accent-light);
  box-shadow:0 1px 4px #1976d21a;
  transition:border 0.2s,box-shadow 0.2s;
}

.signature-container {
  background: transparent !important;
  border: 1.5px dashed var(--accent);
}

.signature-container img{
  max-width: 100%;
  max-height: 100%;
  pointer-events: none;
  background: transparent !important;
}
.overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);z-index:999;display:none;
}
.signature-pad{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(26,34,51,0.95);
  padding:18px 24px;border-radius:14px;
  box-shadow:0 0 24px #1976d22a;
  z-index:1000;display:none;width:370px;
}
#signature-canvas{
  width:100%;height:150px;
  border:1.5px solid var(--accent);
  border-radius:8px;
  background:white;
}
.signature-pad h3{
  color:var(--accent-light);
  margin-bottom:10px;
  font-size:1.2rem;
}
.signature-pad .btn{
  margin:6px 4px 0 0;
  background:var(--button-bg);
  color:white;
  border:none;
  font-size:1rem;
  border-radius:50px;
  padding:8px 18px;
}
.signature-pad .btn:hover{
  background:var(--button-hover);
  filter:brightness(1.08);
}
::-webkit-scrollbar{width:10px;background:var(--primary-dark);}
::-webkit-scrollbar-thumb{background:var(--accent);border-radius:8px;}
@media (max-width:900px) {
  .toolbar {
    flex-wrap: nowrap;
    overflow-x: auto;
    padding: 0 2vw;
    background: var(--primary-dark);
    border-bottom: 1.5px solid var(--border);
    box-shadow: var(--shadow);
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    z-index: 100;
    justify-content: flex-start;
    align-items: center;
    height: 60px;
    min-height: 60px;
  }
  .container {
    padding-top: 60px !important;
  }
  .toolbar .toolbar-toggle {
    display: none !important;
  }
  .toolbar .toolbar-inner {
    display: flex !important;
    flex-direction: row;
    width: 100vw;
    background: none;
    position: static;
    box-shadow: none;
    border-radius: 0;
    padding: 0;
    gap: 0;
  }
  .toolbar button,
  .toolbar label {
    min-width: 44px;
    min-height: 44px;
    padding: 0 10px;
    font-size: 1.1rem;
    border-radius: 12px;
    margin: 0 2px;
    gap: 0;
    justify-content: center;
  }
  .file-name {
    display: none;
  }
}
@media (max-width:600px) {
  .toolbar {
    height: 52px;
    min-height: 52px;
    padding: 0 1vw;
  }
  .container {
    padding-top: 52px !important;
  }
  .toolbar .toolbar-inner {
    font-size: 0.95rem;
  }
  .toolbar button,
  .toolbar label {
    font-size: 1rem;
    min-width: 40px;
    min-height: 40px;
    border-radius: 10px;
    padding: 0 6px;
  }
}
@media (min-width: 601px) {
  .toolbar .toolbar-toggle { display: none !important; }
  .toolbar .toolbar-inner { display: flex !important; flex-direction: row; position: static; width: auto; box-shadow: none; background: none; }
}

/* Print styles */
@media print {
  body, html {
    background:white !important;
    padding:0 !important;
    margin:0 !important;
    display:block !important;
    width:100% !important;
    height:100% !important;
  }
  .toolbar, .text-input-container, .overlay, .signature-pad, .container > .toolbar {
    display:none !important;
  }
  .container{
    box-shadow:none !important;
    border:none !important;
    width:100% !important;
    max-width:100% !important;
    margin:0 !important;
    padding:0 !important;
    background:white !important;
  }
  .editor-container{
    padding:0 !important;
    margin:0 !important;
    background:white !important;
    overflow:visible !important;
    height:auto !important;
  }
  .document-preview{
    position:relative !important;
    width:210mm !important;
    height:297mm !important;
    margin:0 auto !important;
    padding:15mm 10mm 15mm 10mm !important; /* A4 with minimal margin */
    box-sizing:border-box !important;
    background:white !important;
    overflow:visible !important;
    border:none !important;
    box-shadow:none !important;
    border-radius:0 !important;
    page-break-inside:avoid !important;
  }
  #pdf-container, #excel-container, #uploaded-image {
    width:100% !important;
    height:auto !important;
    display:block !important;
  }
  #pdf-container canvas {
    width:100% !important;
    height:auto !important;
    max-width:100% !important;
    page-break-inside:avoid !important;
  }
  .document-content { display:none !important; }
  .signature-container,
  .draggable-text {
    display:block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background:transparent !important;
    color:black !important;
    page-break-inside:avoid !important;
    border: 1px solid #000 !important;
  }
  .signature-container img {
    background:transparent !important;
    filter: none !important;
  }
  #drawing-canvas { display: none !important; }
  #drawing-canvas-print {
    display:block !important;
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 50 !important;
    pointer-events: none !important;
    background: transparent !important;
  }
}

/* Text input styling */
.text-input-container {
  position: absolute;
  z-index: 70;
  background: rgba(35, 42, 52, 0.9);
  border: 1px solid var(--accent);
  border-radius: 6px;
  padding: 5px;
  display: none;
}
.text-input {
  background: transparent !important;
  border: none;
  color: var(--text);
  font-size: 16px;
  width: 200px;
  outline: none;
  padding: 5px;
}

/* Resize handle for signatures */
.resize-handle {
  position: absolute;
  width: 12px;
  height: 12px;
  background: var(--accent);
  border-radius: 50%;
  bottom: -5px;
  right: -5px;
  cursor: nwse-resize;
  z-index: 25;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
  <div class="toolbar">
    <button class="toolbar-toggle" aria-label="Menu"><i class="fas fa-bars"></i></button>
    <div class="toolbar-inner">
      <label class="btn tooltip" id="browse-btn"><i class="fas fa-folder-open"></i> Hap
        <input type="file" id="file-input" accept="application/pdf,.pdf,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx,application/vnd.ms-excel,.xls,image/jpeg,.jpg,image/png,.png,image/gif,.gif,image/bmp,.bmp,image/webp,.webp">
        <span class="tooltiptext">Ngarko dokument</span>
      </label>
      <span class="file-name" id="file-name">Asnjë dokument</span>
      <button class="tool-button active tooltip" data-tool="select"><i class="fas fa-mouse-pointer"></i> Selekto</button>
      <button class="tool-button tooltip" data-tool="text"><i class="fas fa-font"></i> Tekst</button>
      <button class="tool-button tooltip" data-tool="pen"><i class="fas fa-pen"></i> Laps</button>
      <button class="tool-button tooltip" data-tool="highlight"><i class="fas fa-highlighter"></i> Thekso</button>
      <button class="tool-button tooltip" data-tool="eraser"><i class="fas fa-eraser"></i> Fshij</button>
      <button class="tool-button tooltip" data-tool="signature"><i class="fas fa-signature"></i> Nënshkrim</button>
      <button class="btn tooltip" id="save-btn"><i class="fas fa-save"></i> Ruaj</button>
      <button class="btn tooltip" id="reset-btn"><i class="fas fa-undo"></i> Rikthe</button>
      <button class="btn tooltip" id="print-btn"><i class="fas fa-print"></i> Printo</button>
    </div>
  </div>

  <div class="editor-container">
    <div class="document-preview" id="document-preview">
      <div id="pdf-container"></div>
      <div id="excel-container"></div>
      <div class="document-content" id="document-content">
        <i class="fas fa-file-alt" style="font-size:3.5rem;color:#1976d2;margin-bottom:18px;"></i>
        <h1>Mirësevini</h1>
        <p>Zgjidhni dokumentin për të filluar redaktimin.<br>
        <span style="color:var(--accent-light);"><b>KLIKO</b> Zgjidh Dokument ose tërhiqni dokumentin këtu.</span></p>
      </div>
    </div>

    <canvas id="drawing-canvas"></canvas>

    <div class="text-input-container" id="text-input-container">
      <input type="text" class="text-input" id="text-input" placeholder="Shkruaj tekstin këtu...">
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <div class="signature-pad" id="signature-pad">
    <h3>Shto nënshkrimin</h3>
    <canvas id="signature-canvas" width="350" height="150"></canvas>
    <div style="text-align:center;margin-top:10px;">
      <button class="btn" id="apply-signature">Shto</button>
      <button class="btn" id="clear-signature">Pastro</button>
      <button class="btn" id="cancel-signature">Anulo</button>
    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const fileInput = document.getElementById('file-input');
  const fileName = document.getElementById('file-name');
  const documentPreview = document.getElementById('document-preview');
  const pdfContainer = document.getElementById('pdf-container');
  const excelContainer = document.getElementById('excel-container');
  const documentContent = document.getElementById('document-content');
  const drawingCanvas = document.getElementById('drawing-canvas');
  const saveBtn = document.getElementById('save-btn');
  const resetBtn = document.getElementById('reset-btn');
  const printBtn = document.getElementById('print-btn');
  const toolButtons = document.querySelectorAll('.tool-button');
  const signaturePad = document.getElementById('signature-pad');
  const signatureCanvas = document.getElementById('signature-canvas');
  const applySignature = document.getElementById('apply-signature');
  const clearSignature = document.getElementById('clear-signature');
  const cancelSignature = document.getElementById('cancel-signature');
  const overlay = document.getElementById('overlay');
  const textInputContainer = document.getElementById('text-input-container');
  const textInput = document.getElementById('text-input');

  // State
  let currentFile = null;
  let currentTool = 'select';
  let isDrawing = false;
  let lastX = 0, lastY = 0;
  let sigDrawing = false, lastSigX = 0, lastSigY = 0;
  let textPosition = { x: 0, y: 0 };
  let activeTextInput = null;
  let textArmed = false;

  // Drawing context
  const ctx = drawingCanvas.getContext('2d');
  const sigCtx = signatureCanvas.getContext('2d');

  // Initialize canvas
  function resizeCanvas() {
    drawingCanvas.width = Math.max(1, documentPreview.clientWidth);
    drawingCanvas.height = Math.max(1, documentPreview.clientHeight);
    drawingCanvas.style.width = drawingCanvas.width + 'px';
    drawingCanvas.style.height = drawingCanvas.height + 'px';
  }

  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // Signature canvas setup
  sigCtx.fillStyle = 'white';
  sigCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
  sigCtx.strokeStyle = '#000';
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = 'round';

  // Toggle pointer events based on current tool
  function updateCanvasPointerEvents() {
    if (currentTool === 'pen' || currentTool === 'highlight' || currentTool === 'eraser') {
      drawingCanvas.style.pointerEvents = 'auto';
    } else {
      drawingCanvas.style.pointerEvents = 'none';
    }
  }

  // Tool button handlers
  toolButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      currentTool = btn.dataset.tool;
      toolButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (currentTool === 'signature') {
        openSignaturePad();
      } else if (currentTool === 'text') {
        textArmed = true;
        setupTextInput();
      } else {
        textArmed = false;
      }
      updateCanvasPointerEvents();
    });
  });

  updateCanvasPointerEvents();

  // Get relative coordinates
  function getRelativeCoords(e, el) {
    const rect = el.getBoundingClientRect();
    let x, y;
    if (e.touches && e.touches.length) {
      x = e.touches[0].clientX - rect.left;
      y = e.touches[0].clientY - rect.top;
    } else {
      x = e.clientX - rect.left;
      y = e.clientY - rect.top;
    }
    x = Math.max(0, Math.min(x, rect.width));
    y = Math.max(0, Math.min(y, rect.height));
    return { x, y };
  }

  /* -----------------------
     TEXT TOOL (one-shot)
     ----------------------- */
  documentPreview.addEventListener('click', (e) => {
    if (currentTool === 'text' && textArmed) {
      const coords = getRelativeCoords(e, documentPreview);
      textPosition = { x: coords.x, y: coords.y };
      showTextInput(coords.x, coords.y);
      textArmed = false;
      currentTool = 'select';
      toolButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tool === 'select'));
      updateCanvasPointerEvents();
    }
  });

  function setupTextInput() {
    if (activeTextInput) {
      activeTextInput.remove();
      activeTextInput = null;
    }
    textInput.value = '';
    textInputContainer.style.display = 'none';
    textInput.onkeydown = function (ev) {
      if (ev.key === 'Enter') {
        addTextElement(textInput.value, textPosition.x, textPosition.y);
        hideTextInput();
      } else if (ev.key === 'Escape') {
        hideTextInput();
      }
    };
    textInput.onblur = function () {
      if (textInput.value.trim() !== '') {
        addTextElement(textInput.value, textPosition.x, textPosition.y);
      }
      hideTextInput();
    };
  }

  function showTextInput(x, y) {
    if (activeTextInput) {
      activeTextInput.remove();
      activeTextInput = null;
    }
    textInput.value = '';
    textInputContainer.style.display = 'block';
    const rect = documentPreview.getBoundingClientRect();
    const left = Math.min(Math.max(8, x), rect.width - 220);
    const top = Math.min(Math.max(8, y), rect.height - 40);
    textInputContainer.style.left = left + 'px';
    textInputContainer.style.top = top + 'px';
    setTimeout(() => textInput.focus(), 0);
    activeTextInput = textInputContainer;
  }

  function hideTextInput() {
    if (activeTextInput) {
      activeTextInput.style.display = 'none';
      activeTextInput = null;
    }
  }

  function addTextElement(text, x, y) {
    if (!text || !text.trim()) return;
    if (activeTextInput) {
      activeTextInput.style.display = 'none';
      activeTextInput = null;
    }
    const textDiv = document.createElement('div');
    textDiv.className = 'draggable-text';
    textDiv.innerText = text;
    textDiv.style.left = x + 'px';
    textDiv.style.top = y + 'px';
    
    const removeBtn = document.createElement('button');
    removeBtn.innerHTML = '✖';
    removeBtn.title = 'Fshi';
    removeBtn.style.position = 'absolute';
    removeBtn.style.right = '-10px';
    removeBtn.style.top = '-10px';
    removeBtn.style.background = 'var(--accent)';
    removeBtn.style.border = 'none';
    removeBtn.style.borderRadius = '12px';
    removeBtn.style.width = '22px';
    removeBtn.style.height = '22px';
    removeBtn.style.color = 'white';
    removeBtn.style.cursor = 'pointer';
    removeBtn.addEventListener('click', (ev) => { ev.stopPropagation(); textDiv.remove(); });
    textDiv.appendChild(removeBtn);

    documentPreview.appendChild(textDiv);
    makeDraggable(textDiv);
  }

  /* -----------------------
     DRAWING (pen/highlight/eraser)
     ----------------------- */
  drawingCanvas.addEventListener('mousedown', (e) => {
    if (currentTool === 'pen' || currentTool === 'highlight' || currentTool === 'eraser') {
      isDrawing = true;
      const coords = getRelativeCoords(e, drawingCanvas);
      lastX = coords.x; lastY = coords.y;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-light').trim() || '#42a5f5';
        ctx.lineWidth = 2;
        ctx.globalAlpha = 1.0;
      } else if (currentTool === 'highlight') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = 'rgba(255,255,0,0.4)';
        ctx.lineWidth = 18;
        ctx.globalAlpha = 1.0;
      } else if (currentTool === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)';
        ctx.lineWidth = 18;
        ctx.globalAlpha = 1.0;
      }
    }
  });

  drawingCanvas.addEventListener('mousemove', (e) => {
    if (!isDrawing) return;
    const coords = getRelativeCoords(e, drawingCanvas);
    ctx.lineTo(coords.x, coords.y);
    ctx.stroke();
    lastX = coords.x; lastY = coords.y;
  });
  // TOUCH EVENTS FOR DRAWING
  drawingCanvas.addEventListener('touchstart', (e) => {
    if (currentTool === 'pen' || currentTool === 'highlight' || currentTool === 'eraser') {
      isDrawing = true;
      const coords = getRelativeCoords(e, drawingCanvas);
      lastX = coords.x; lastY = coords.y;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-light').trim() || '#42a5f5';
        ctx.lineWidth = 2;
        ctx.globalAlpha = 1.0;
      } else if (currentTool === 'highlight') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.strokeStyle = 'rgba(255,255,0,0.4)';
        ctx.lineWidth = 18;
        ctx.globalAlpha = 1.0;
      } else if (currentTool === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,1)';
        ctx.lineWidth = 18;
        ctx.globalAlpha = 1.0;
      }
    }
    e.preventDefault();
  }, {passive:false});
  drawingCanvas.addEventListener('touchmove', (e) => {
    if (!isDrawing) return;
    const coords = getRelativeCoords(e, drawingCanvas);
    ctx.lineTo(coords.x, coords.y);
    ctx.stroke();
    lastX = coords.x; lastY = coords.y;
    e.preventDefault();
  }, {passive:false});
  ['mouseup', 'mouseout', 'touchend', 'touchcancel'].forEach(ev => {
    drawingCanvas.addEventListener(ev, () => {
      isDrawing = false;
      ctx.globalCompositeOperation = 'source-over';
      ctx.globalAlpha = 1.0;
    });
  });

  /* -----------------------
     SIGNATURE PAD
     ----------------------- */
  function openSignaturePad() {
    signaturePad.style.display = 'block';
    overlay.style.display = 'block';
    sigCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    sigCtx.fillStyle = 'white';
    sigCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    sigCtx.strokeStyle = '#000';
    sigCtx.lineWidth = 2;
  }

  signatureCanvas.addEventListener('mousedown', (e) => {
    sigDrawing = true;
    const rect = signatureCanvas.getBoundingClientRect();
    lastSigX = e.clientX - rect.left;
    lastSigY = e.clientY - rect.top;
    sigCtx.beginPath();
    sigCtx.moveTo(lastSigX, lastSigY);
  });
  signatureCanvas.addEventListener('mousemove', (e) => {
    if (!sigDrawing) return;
    const rect = signatureCanvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    sigCtx.lineTo(x, y);
    sigCtx.stroke();
    lastSigX = x; lastSigY = y;
  });
  ['mouseup', 'mouseout', 'touchend', 'touchcancel'].forEach(ev => {
    signatureCanvas.addEventListener(ev, () => { sigDrawing = false; });
  });

  applySignature.addEventListener('click', () => {
    const temp = document.createElement('canvas');
    temp.width = signatureCanvas.width;
    temp.height = signatureCanvas.height;
    const tctx = temp.getContext('2d');
    // Draw signature with transparent background
    tctx.fillStyle = 'rgba(0,0,0,0)';
    tctx.fillRect(0, 0, temp.width, temp.height);
    tctx.drawImage(signatureCanvas, 0, 0);
    const data = temp.toDataURL('image/png');
    const sigDiv = document.createElement('div');
    sigDiv.className = 'signature-container';
    const img = document.createElement('img');
    img.src = data;
    img.style.pointerEvents = 'none';
    img.style.display = 'block';
    sigDiv.appendChild(img);
    
    const handle = document.createElement('div');
    handle.className = 'resize-handle';
    sigDiv.appendChild(handle);

    sigDiv.style.left = '20px';
    sigDiv.style.top = '20px';
    documentPreview.appendChild(sigDiv);
    makeDraggableAndResizable(sigDiv);
    signaturePad.style.display = 'none';
    overlay.style.display = 'none';
  });

  clearSignature.addEventListener('click', () => {
    sigCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    sigCtx.fillStyle = 'white';
    sigCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
    sigCtx.strokeStyle = '#000';
  });
  cancelSignature.addEventListener('click', () => {
    signaturePad.style.display = 'none';
    overlay.style.display = 'none';
  });
  overlay.addEventListener('click', () => {
    signaturePad.style.display = 'none';
    overlay.style.display = 'none';
  });

  /* -----------------------
     Draggable / Resizable helpers
     ----------------------- */
  function makeDraggableAndResizable(el) {
    let dragging = false, resizing = false, offsetX = 0, offsetY = 0;
    el.addEventListener('mousedown', (ev) => {
      const target = ev.target;
      if (target.classList.contains('resize-handle')) {
        resizing = true;
      } else {
        dragging = true;
        const rect = el.getBoundingClientRect();
        offsetX = ev.clientX - rect.left;
        offsetY = ev.clientY - rect.top;
        el.style.border = '2px dashed var(--accent)';
      }
      ev.stopPropagation();
    });
    document.addEventListener('mousemove', (ev) => {
      if (dragging) {
        const rect = documentPreview.getBoundingClientRect();
        el.style.left = (ev.clientX - rect.left - offsetX + documentPreview.scrollLeft) + 'px';
        el.style.top = (ev.clientY - rect.top - offsetY + documentPreview.scrollTop) + 'px';
      } else if (resizing) {
        const rect = documentPreview.getBoundingClientRect();
        const left = parseFloat(el.style.left) || 0;
        const top = parseFloat(el.style.top) || 0;
        const width = Math.max(80, ev.clientX - rect.left - left);
        const height = Math.max(40, ev.clientY - rect.top - top);
        el.style.width = width + 'px';
        const img = el.querySelector('img');
        if (img) {
          img.style.width = width + 'px';
          img.style.height = height + 'px';
        }
      }
    });
    document.addEventListener('mouseup', () => {
      dragging = false; resizing = false;
      el.style.border = '1.5px dashed var(--accent)';
    });
  }

  function makeDraggable(el) {
    let dragging = false, offsetX = 0, offsetY = 0;
    el.addEventListener('mousedown', (ev) => {
      dragging = true;
      offsetX = ev.offsetX;
      offsetY = ev.offsetY;
      el.style.border = '2px dashed var(--accent)';
      ev.stopPropagation();
    });
    document.addEventListener('mousemove', (ev) => {
      if (!dragging) return;
      const rect = documentPreview.getBoundingClientRect();
      el.style.left = (ev.clientX - rect.left - offsetX + documentPreview.scrollLeft) + 'px';
      el.style.top = (ev.clientY - rect.top - offsetY + documentPreview.scrollTop) + 'px';
    });
    document.addEventListener('mouseup', () => {
      dragging = false;
      el.style.border = '1.5px dashed var(--accent)';
    });
  }

  /* -----------------------
     File loading
     ----------------------- */
  fileInput.addEventListener('change', (e) => {
    if (e.target.files[0]) loadFile(e.target.files[0]);
  });

  function loadFile(file) {
    currentFile = file;
    fileName.textContent = file.name;
    const ext = file.name.split('.').pop().toLowerCase();
    documentContent.style.display = 'none';
    if (ext === 'pdf') loadPDF(file);
    else if (ext === 'xls' || ext === 'xlsx') loadExcel(file);
    else if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(ext)) loadImage(file);
    else { alert('Format jo i suportuar'); documentContent.style.display = 'block'; }
  }

  function loadImage(file) {
    pdfContainer.style.display = 'none';
    excelContainer.style.display = 'none';
    documentContent.style.display = 'none';
    const prevImg = document.getElementById('uploaded-image');
    if (prevImg) prevImg.remove();
    const reader = new FileReader();
    reader.onload = function (ev) {
      const img = document.createElement('img');
      img.id = 'uploaded-image';
      img.src = ev.target.result;
      img.style.maxWidth = '100%';
      img.style.maxHeight = '700px';
      img.style.display = 'block';
      img.style.margin = '0 auto';
      img.style.position = 'relative';
      img.style.zIndex = '10';
      documentPreview.appendChild(img);
      drawingCanvas.style.zIndex = '40';
      drawingCanvas.style.display = 'block';
      resizeCanvas();
    };
    reader.readAsDataURL(file);
  }

  function loadPDF(file) {
    pdfContainer.innerHTML = '';
    pdfContainer.style.display = 'block';
    excelContainer.style.display = 'none';
    const reader = new FileReader();
    reader.onload = function () {
      const typedarray = new Uint8Array(this.result);
      pdfjsLib.getDocument({ data: typedarray }).promise.then(pdf => {
        pdfContainer.innerHTML = '';
        let renderPage = function (pageNum) {
          pdf.getPage(pageNum).then(page => {
            const scale = 1.2;
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            const ctx2 = canvas.getContext('2d');
            page.render({ canvasContext: ctx2, viewport }).promise.then(() => {
              pdfContainer.appendChild(canvas);
              if (pageNum < pdf.numPages) renderPage(pageNum + 1);
              resizeCanvas();
            });
          }).catch(err => {
            console.error('PDF page error', err);
          });
        };
        renderPage(1);
      }).catch(err => {
        alert('PDF nuk mund të hapet: ' + err.message);
        documentContent.style.display = 'block';
      });
    };
    reader.onerror = function () {
      alert('Gabim gjatë leximit të PDF.');
      documentContent.style.display = 'block';
    };
    reader.readAsArrayBuffer(file);
  }

  function loadExcel(file) {
    excelContainer.innerHTML = '';
    excelContainer.style.display = 'block';
    pdfContainer.style.display = 'none';
    const reader = new FileReader();
    reader.onload = function (e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      workbook.SheetNames.forEach(function (sheetName) {
        const rowObj = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
        if (rowObj.length > 0) {
          const html = XLSX.utils.sheet_to_html(workbook.Sheets[sheetName]);
          const div = document.createElement('div');
          div.innerHTML = html;
          excelContainer.appendChild(div);
        }
      });
      resizeCanvas();
    };
    reader.readAsArrayBuffer(file);
  }

  /* -----------------------
     Save / Reset
     ----------------------- */
  saveBtn.addEventListener('click', () => {
    const preview = document.getElementById('document-preview');
    // Add drawing overlay for export
    let tempImg = document.getElementById('drawing-canvas-print');
    if (!tempImg && drawingCanvas.width > 0 && drawingCanvas.height > 0) {
      tempImg = document.createElement('img');
      tempImg.id = 'drawing-canvas-print';
      tempImg.src = drawingCanvas.toDataURL('image/png');
      tempImg.style.position = 'absolute';
      tempImg.style.left = '0';
      tempImg.style.top = '0';
      tempImg.style.width = '100%';
      tempImg.style.height = '100%';
      tempImg.style.zIndex = '9999';
      tempImg.style.pointerEvents = 'none';
      tempImg.style.background = 'transparent';
      preview.appendChild(tempImg);
    }
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = function() {
      window.html2canvas(preview, {backgroundColor: null}).then(canvas => {
        const link = document.createElement('a');
        link.download = (fileName.textContent || 'dokument') + '-me-ndryshime.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        if (tempImg) tempImg.remove();
      });
    };
    document.body.appendChild(script);
  });

  resetBtn.addEventListener('click', () => {
    ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    documentPreview.querySelectorAll('.signature-container,.draggable-text').forEach(el => el.remove());
    const prevImg = document.getElementById('uploaded-image');
    if (prevImg) prevImg.remove();
    drawingCanvas.style.display = 'none';
    documentContent.style.display = 'block';
    fileName.textContent = 'Asnjë dokument';
    currentFile = null;
    currentTool = 'select';
    toolButtons.forEach(b => b.classList.remove('active'));
    toolButtons[0].classList.add('active');
    updateCanvasPointerEvents();
  });

  // Print Preview: show drawing canvas as image overlay for print, always on top
  printBtn.addEventListener('click',()=>{
    // Remove any previous print overlay
    let prevPrintImg = document.getElementById('drawing-canvas-print');
    if(prevPrintImg) prevPrintImg.remove();
    // Only add if there is drawing
    if (drawingCanvas.width > 0 && drawingCanvas.height > 0) {
      const img = document.createElement('img');
      img.id = 'drawing-canvas-print';
      img.src = drawingCanvas.toDataURL('image/png');
      img.style.position = 'absolute';
      img.style.left = '0';
      img.style.top = '0';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.zIndex = '9999'; // ensure on top
      img.style.pointerEvents = 'none';
      img.style.background = 'transparent';
      // Always append as last child so it's above all content
      const preview = document.getElementById('document-preview');
      preview.appendChild(img);
    }
    window.scrollTo(0,0);
    setTimeout(()=>window.print(), 100); // allow DOM to update
  });
  window.onafterprint = function() {
    let prevPrintImg = document.getElementById('drawing-canvas-print');
    if(prevPrintImg) prevPrintImg.remove();
  };

  // Mobile menu toggle
  const toolbar = document.querySelector('.toolbar');
  const toolbarToggle = document.querySelector('.toolbar-toggle');
  toolbarToggle.addEventListener('click', () => {
    toolbar.classList.toggle('open');
  });
  // Close menu when clicking outside or on a button
  document.addEventListener('click', (e) => {
    if (!toolbar.contains(e.target)) toolbar.classList.remove('open');
    if (e.target.classList.contains('tool-button') || e.target.classList.contains('btn')) toolbar.classList.remove('open');
  });
});
</script>
</body>
</html>
